{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>E-Learning â€” Lectures</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Quill CSS -->
  <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">

  <!-- Quill JS -->
  <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>

  <!-- Bootstrap & Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root {
      --brand: #1f7ae0;
      --brand-2: #0ea5e9;
      --muted: #6b7280;
    }
    body { background: #f8fafc; }
    .navbar-brand { letter-spacing: .3px; }
    .card-metric { border: none; }
    .card-metric .icon {
      width: 42px; height: 42px;
      display: inline-flex; align-items: center; justify-content: center;
      border-radius: 10px; background: #eef6ff; color: var(--brand);
    }
    .chip { font-size: 12px; padding: .25rem .5rem; border-radius: 999px; }
    .chip-live { background: #dcfce7; color: #166534; }
    .chip-draft { background: #fee2e2; color: #7f1d1d; }
    .table thead th { font-weight: 600; font-size: 12px; text-transform: uppercase; }
    .table td { vertical-align: middle; }
    .btn-outline-muted { border-color: #e5e7eb; color: #374151; }
    .btn-outline-muted:hover { background: #f3f4f6; }
    .progress.thin { height: 6px; border-radius: 999px; }
    .tag { background: #eef2ff; color: #3730a3; border-radius: 999px; padding: .2rem .5rem; font-size: 11px; }
    .sticky-summary { position: sticky; top: 1rem; }
    .search-input { border-radius: 999px; }
    .table-hover tbody tr:hover { background: #f9fafb; }
    .upload-drop { border: 2px dashed #cbd5e1; border-radius: 12px; padding: 1rem; text-align: center; transition: .2s; }
    .upload-drop.drag { border-color: var(--brand); background: #f0f9ff; }
    .pointer { cursor: pointer; }
  </style>
</head>
<body>

<!-- Topbar -->
<nav class="navbar navbar-expand-lg bg-white border-bottom shadow-sm">
  <div class="container-fluid">
    <a class="navbar-brand fw-semibold" href="#">
      <i class="fa-solid fa-book-open-reader me-2 text-primary"></i>E-Learning
    </a>

    <div class="d-flex ms-auto gap-2">
      <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#uploadModal">
        <i class="fa-solid fa-upload me-2"></i>Upload lecture
      </button>
      <a href="{% url 'export_lectures_csv' %}" class="btn btn-outline-muted">
        <i class="fa-solid fa-file-csv me-2"></i>Export CSV
      </a>
      <button class="btn btn-outline-muted" onclick="print()">
        <i class="fa-solid fa-print me-2"></i>Print
      </button>
    </div>
  </div>
</nav>

<!-- Content -->
<div class="container my-4">
  <div class="row g-4">
    <!-- Main -->
    <div class="col-lg-8">
      <!-- Metrics -->
      <div class="row g-3">
        <div class="col-md-4">
          <div class="card card-metric shadow-sm p-3">
            <div class="d-flex align-items-center justify-content-between">
              <div>
                <div class="text-muted small">Total lectures</div>
                <div class="h4 mb-0" id="metricLectures">{{ total_lectures|default:0 }}</div>
              </div>
              <div class="icon"><i class="fa-solid fa-layer-group"></i></div>
            </div>
            <div class="mt-2 small text-muted">
              New this week: <span class="fw-semibold" id="metricNew">{{ new_this_week|default:0 }}</span>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card card-metric shadow-sm p-3">
            <div class="d-flex align-items-center justify-content-between">
              <div>
                <div class="text-muted small">Total views</div>
                <div class="h4 mb-0" id="metricViews">{{ total_views|default:0 }}</div>
              </div>
              <div class="icon"><i class="fa-solid fa-eye"></i></div>
            </div>
            <div class="mt-2 small text-muted">
              7-day: <span class="fw-semibold" id="metricViews7d">{{ views_7d|default:0 }}</span>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card card-metric shadow-sm p-3">
            <div class="d-flex align-items-center justify-content-between">
              <div>
                <div class="text-muted small">Avg completion</div>
                <div class="h4 mb-0" id="metricCompletion">{{ avg_completion|default:"0%" }}</div>
              </div>
              <div class="icon"><i class="fa-solid fa-chart-line"></i></div>
            </div>
            <div class="mt-2 small">
              <div class="progress thin">
                <div class="progress-bar bg-success" style="width: {{ avg_completion|default_if_none:0 }}%;"></div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Filters & Search -->
      <div class="card shadow-sm mt-3">
        <div class="card-body">
          <div class="row g-3 align-items-center">
            <div class="col-md-5">
              <div class="input-group">
                <span class="input-group-text bg-white border-end-0"><i class="fa-solid fa-magnifying-glass text-muted"></i></span>
                <input type="text" id="searchInput" class="form-control border-start-0 search-input" placeholder="Search by title, course, tag...">
              </div>
            </div>
            <div class="col-md-3">
              <select id="filterCourse" class="form-select">
                <option value="">All courses</option>
                {% for c in courses %}
                  <option value="{{ c.id }}">{{ c.title }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-2">
              <select id="filterStatus" class="form-select">
                <option value="">All statuses</option>
                <option value="LIVE">Live</option>
                <option value="DRAFT">Draft</option>
              </select>
            </div>
            <div class="col-md-2 text-end">
              <div class="btn-group">
                <button class="btn btn-outline-muted btn-sm" id="sortRecent">
                  <i class="fa-solid fa-clock-rotate-left me-1"></i>Recent
                </button>
                <button class="btn btn-outline-muted btn-sm" id="sortViews">
                  <i class="fa-solid fa-fire me-1"></i>Most viewed
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Lectures table -->
      <div class="card shadow-sm mt-3">
        <div class="card-header bg-white d-flex align-items-center justify-content-between">
          <span class="fw-semibold"><i class="fa-solid fa-graduation-cap me-2 text-primary"></i>Lectures</span>
          <span class="small text-muted" id="tableCount"></span>
        </div>
        <div class="table-responsive">
          <table class="table table-hover align-middle" id="lectureTable">
            <thead class="table-light">
              <tr>
                <th class="pointer" data-sort="title">Title</th>
                <th>Course</th>
                <th>Type</th>
                <th>Views</th>
                <th>Tags</th>
                <th>Status</th>
                <th>Added</th>
                <th class="text-end">Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for l in lectures %}
              <tr data-course="{{ l.course.id }}" data-status="{{ l.status }}" data-title="{{ l.title|lower }}" data-tags="{{ l.tags|join:', '|lower }}" data-views="{{ l.views }}" data-date="{{ l.created_at|date:'U' }}">
                <td>
                  <div class="fw-semibold">{{ l.title }}</div>
                  <div class="small text-muted">{{ l.description|truncatechars:80 }}</div>
                </td>
                <td>{{ l.course.title }}</td>
                <td>
                  {% if l.content_type == 'VIDEO' %}
                    <span class="badge bg-primary">Video</span>
                  {% elif l.content_type == 'PDF' %}
                    <span class="badge bg-secondary">PDF</span>
                  {% elif l.content_type == 'AUDIO' %}
                    <span class="badge bg-info text-dark">Audio</span>
                  {% else %}
                    <span class="badge bg-dark">Other</span>
                  {% endif %}
                </td>
                <td>
                  <i class="fa-solid fa-eye text-muted me-1"></i>
                  <span class="fw-semibold">{{ l.views }}</span>
                  <div class="small text-muted">Last: {{ l.last_viewed|default:"-" }}</div>
                </td>
                <td>
                  {% for t in l.tags %}
                    <span class="tag me-1">{{ t }}</span>
                  {% empty %}
                    <span class="text-muted small">No tags</span>
                  {% endfor %}
                </td>
                <td>
                  {% if l.status == 'LIVE' %}
                    <span class="chip chip-live">Live</span>
                  {% else %}
                    <span class="chip chip-draft">Draft</span>
                  {% endif %}
                </td>
                <td>{{ l.created_at|date:"M d, Y" }}</td>
                <td class="text-end">
                  <div class="btn-group">
                    <a href="{% url 'lecture_preview' l.id %}" class="btn btn-sm btn-outline-muted">
                      <i class="fa-solid fa-play me-1"></i>Preview
                    </a>
                    <button class="btn btn-sm btn-outline-muted js-toggle-status" data-id="{{ l.id }}">
                      <i class="fa-solid fa-toggle-on me-1"></i>Toggle
                    </button>
                    <button class="btn btn-sm btn-outline-danger js-delete" data-id="{{ l.id }}">
                      <i class="fa-solid fa-trash me-1"></i>Delete
                    </button>
                  </div>
                </td>
              </tr>
              {% empty %}
              <tr>
                <td colspan="8" class="text-center py-4 text-muted">No lectures yet. Upload your first lecture to get started.</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Summary -->
    <div class="col-lg-4">
      <div class="sticky-summary">
        <div class="card shadow-sm">
          <div class="card-header bg-white">
            <span class="fw-semibold"><i class="fa-solid fa-chart-pie me-2 text-primary"></i>Summary</span>
          </div>
          <div class="card-body">
            <div class="row g-3">
              <div class="col-6">
                <div class="p-3 rounded border">
                  <div class="text-muted small">Storage used</div>
                  <div class="h5 mb-1" id="summaryStorage">{{ storage_used|default:"0 GB" }}</div>
                  <div class="progress thin">
                    <div class="progress-bar bg-primary" style="width: {{ storage_pct|default_if_none:0 }}%;"></div>
                  </div>
                </div>
              </div>
              <div class="col-6">
                <div class="p-3 rounded border">
                  <div class="text-muted small">Completion (avg)</div>
                  <div class="h5 mb-1">{{ avg_completion|default:"0%" }}</div>
                  <div class="small text-muted">Based on student sessions</div>
                </div>
              </div>
            </div>

            <div class="mt-3">
              <canvas id="chartTypes" height="160"></canvas>
            </div>
            <div class="mt-3">
              <canvas id="chartViews" height="160"></canvas>
            </div>

            <div class="mt-3">
              <div class="d-flex justify-content-between align-items-center">
                <span class="text-muted small">Top tags</span>
                <span class="small text-muted" id="tagCount"></span>
              </div>
              <div id="topTags" class="mt-2 d-flex flex-wrap gap-2">
                {% for tag,count in top_tags %}
                  <span class="tag">{{ tag }} ({{ count }})</span>
                {% endfor %}
                {% if not top_tags %}
                  <span class="text-muted small">No tags yet</span>
                {% endif %}
              </div>
            </div>
          </div>
        </div>

        <div class="card shadow-sm mt-3">
          <div class="card-header bg-white">
            <span class="fw-semibold"><i class="fa-solid fa-bell me-2 text-primary"></i>Recent activity</span>
          </div>
          <div class="list-group list-group-flush">
            {% for a in recent_activity %}
            <div class="list-group-item d-flex justify-content-between">
              <div>
                <div class="small">{{ a.message }}</div>
                <div class="small text-muted">{{ a.created_at|timesince }} ago</div>
              </div>
              <span class="badge bg-light text-muted">{{ a.type }}</span>
            </div>
            {% empty %}
            <div class="list-group-item text-muted small">No activity yet.</div>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Upload modal -->
<div class="modal fade" id="uploadModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <form id="uploadForm" method="POST" action="{% url 'lecture_upload' %}" enctype="multipart/form-data">
        {% csrf_token %}
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title"><i class="fa-solid fa-upload me-2"></i>Upload lecture</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="row g-3">
            <div class="col-md-8">
              <label class="form-label">Title</label>
              <input type="text" name="title" class="form-control" placeholder="e.g., Introduction to Thermodynamics" required>
            </div>
            <div class="col-md-4">
              <label class="form-label">Course</label>
              <select name="course_id" class="form-select" required>
                {% for c in courses %}
                  <option value="{{ c.id }}">{{ c.title }}</option>
                {% endfor %}
              </select>
            </div>

            <div class="col-12">
              <label class="form-label">Description</label>
              <!-- Quill editor container -->
                <div id="description-editor" style="height: 300px;"></div>

                <!-- Hidden input to store HTML for form submission -->
                <input type="hidden" name="description" id="description">


            </div>

            <div class="col-md-4">
              <label class="form-label">Content type</label>
              <select name="content_type" class="form-select" required>
                <option value="VIDEO">Video (.mp4)</option>
                <option value="PDF">PDF (.pdf)</option>
                <option value="AUDIO">Audio (.mp3)</option>
                <option value="LINK">External link</option>
              </select>
            </div>
            <div class="col-md-8">
              <label class="form-label">File / Link</label>
              <div class="upload-drop" id="dropZone">
                <i class="fa-solid fa-cloud-arrow-up me-2"></i>
                <span id="dropText">Drag & drop file or click to select</span>
                <input type="file" name="file" id="fileInput" class="d-none" accept=".mp4,.pdf,.mp3">
              </div>
              <input type="url" name="external_url" id="externalUrl" class="form-control mt-2 d-none" placeholder="https://...">
            </div>

            <div class="col-md-6">
              <label class="form-label">Tags</label>
              <input type="text" name="tags" class="form-control" placeholder="comma,separated,tags">
              <div class="form-text">Use simple, consistent tags (e.g., algebra, week-1)</div>
            </div>
            <div class="col-md-3">
              <label class="form-label">Duration (mins)</label>
              <input type="number" name="duration" class="form-control" min="1" placeholder="e.g., 45">
            </div>
            <div class="col-md-3">
              <label class="form-label">Status</label>
              <select name="status" class="form-select">
                <option value="LIVE">Live</option>
                <option value="DRAFT">Draft</option>
              </select>
            </div>

            <div class="col-12">
              <div class="progress thin d-none" id="uploadProgressWrap">
                <div class="progress-bar" id="uploadProgress" style="width:0%"></div>
              </div>
              <div class="small mt-2 text-muted" id="uploadStatus"></div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-primary" type="submit"><i class="fa-solid fa-save me-2"></i>Save</button>
          <button class="btn btn-secondary" data-bs-dismiss="modal" type="button">Cancel</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script>
  // Helpers
  const debounce = (fn, ms=250) => { let t; return (...args) => { clearTimeout(t); t=setTimeout(()=>fn(...args), ms); }; };

  // Search & filters
  function applyFilters() {
    const q = $('#searchInput').val().toLowerCase().trim();
    const course = $('#filterCourse').val();
    const status = $('#filterStatus').val();
    let count = 0;

    $('#lectureTable tbody tr').each(function() {
      const title = $(this).data('title') || '';
      const tags = $(this).data('tags') || '';
      const courseId = String($(this).data('course') || '');
      const st = $(this).data('status') || '';
      const matchesText = !q || title.includes(q) || tags.includes(q);
      const matchesCourse = !course || courseId === course;
      const matchesStatus = !status || st === status;
      const show = matchesText && matchesCourse && matchesStatus;
      $(this).toggle(show);
      if (show) count++;
    });

    $('#tableCount').text(`${count} item${count===1?'':'s'} shown`);
  }

  $('#searchInput').on('input', debounce(applyFilters, 200));
  $('#filterCourse, #filterStatus').on('change', applyFilters);

  // Sorting
  function sortRows(by) {
    const rows = $('#lectureTable tbody tr').get();
    rows.sort((a,b) => {
      if (by === 'views') return ($(b).data('views')||0) - ($(a).data('views')||0);
      if (by === 'recent') return ($(b).data('date')||0) - ($(a).data('date')||0);
      if (by === 'title') return ($(a).data('title')||'').localeCompare($(b).data('title')||'');
      return 0;
    });
    $('#lectureTable tbody').empty().append(rows);
  }
  $('#sortViews').on('click', () => sortRows('views'));
  $('#sortRecent').on('click', () => sortRows('recent'));
  $('[data-sort="title"]').on('click', () => sortRows('title'));

  // Toggle status
  $('.js-toggle-status').on('click', function() {
    const id = $(this).data('id');
    $.post('{% url "lecture_toggle_status" %}', {
      lecture_id: id,
      csrfmiddlewaretoken: $('input[name=csrfmiddlewaretoken]').val()
    }).done(() => {
      location.reload();
    }).fail(xhr => alert('Error toggling status: ' + xhr.responseText));
  });

  // Delete
  $('.js-delete').on('click', function() {
    if (!confirm('Delete this lecture? This cannot be undone.')) return;
    const id = $(this).data('id');
    $.post('{% url "lecture_delete" %}', {
      lecture_id: id,
      csrfmiddlewaretoken: $('input[name=csrfmiddlewaretoken]').val()
    }).done(() => {
      location.reload();
    }).fail(xhr => alert('Error deleting: ' + xhr.responseText));
  });

  // Upload interaction
  const $type = $('select[name="content_type"]');
  const $file = $('#fileInput');
  const $link = $('#externalUrl');
  const $drop = $('#dropZone');
  const $progressWrap = $('#uploadProgressWrap');
  const $progress = $('#uploadProgress');
  const $status = $('#uploadStatus');

  function updateInputMode() {
    const t = $type.val();
    if (t === 'LINK') {
      $file.val('');
      $link.removeClass('d-none');
      $drop.addClass('d-none');
    } else {
      $link.val('');
      $link.addClass('d-none');
      $drop.removeClass('d-none');
      const accept = t === 'VIDEO' ? '.mp4' : t === 'PDF' ? '.pdf' : t === 'AUDIO' ? '.mp3' : '*';
      $file.attr('accept', accept);
    }
  }
  $type.on('change', updateInputMode);
  updateInputMode();

  // Drag & drop
  $drop.on('click', () => $file.trigger('click'));
  $drop.on('dragover', (e) => { e.preventDefault(); $drop.addClass('drag'); });
  $drop.on('dragleave drop', () => $drop.removeClass('drag'));
  $drop.on('drop', (e) => {
    e.preventDefault();
    const f = e.originalEvent.dataTransfer.files[0];
    if (f) $file[0].files = e.originalEvent.dataTransfer.files;
    $('#dropText').text(f ? f.name : 'Drag & drop file or click to select');
  });
  $file.on('change', () => {
    const f = $file[0].files[0];
    $('#dropText').text(f ? f.name : 'Drag & drop file or click to select');
  });

  // Upload with AJAX + progress
  $('#uploadForm').on('submit', function(e) {
    e.preventDefault();

    const ct = $type.val();
    if (ct !== 'LINK' && !$file[0].files.length) {
      alert('Please select a file.');
      return;
    }
    if (ct === 'LINK' && !$link.val()) {
      alert('Please provide the external URL.');
      return;
    }

    const formData = new FormData(this);
    $progressWrap.removeClass('d-none');
    $progress.css('width', '0%');
    $status.text('Uploading...');

    $.ajax({
      url: $(this).attr('action'),
      type: 'POST',
      data: formData,
      processData: false,
      contentType: false,
      xhr: function() {
        const xhr = new window.XMLHttpRequest();
        xhr.upload.addEventListener('progress', function(e) {
          if (e.lengthComputable) {
            const pct = Math.round((e.loaded / e.total) * 100);
            $progress.css('width', pct + '%');
          }
        });
        return xhr;
      }
    }).done(function() {
      $status.text('Upload complete.');
      setTimeout(() => {
        const modal = bootstrap.Modal.getInstance(document.getElementById('uploadModal'));
        modal.hide();
        location.reload();
      }, 500);
    }).fail(function(xhr) {
      $status.text('Upload failed.');
      alert('Error: ' + xhr.responseText);
    });
  });

  // Charts
  const typesData = JSON.parse('{{ types_breakdown_json|default:"{}"|escapejs }}'); // {VIDEO: 10, PDF: 5, AUDIO: 2}
  const typeLabels = Object.keys(typesData);
  const typeValues = Object.values(typesData);

  const typeCtx = document.getElementById('chartTypes');
  if (typeCtx) {
    new Chart(typeCtx, {
      type: 'doughnut',
      data: {
        labels: typeLabels.length ? typeLabels : ['No data'],
        datasets: [{ data: typeValues.length ? typeValues : [1], backgroundColor: ['#60a5fa','#93c5fd','#bfdbfe','#c7d2fe'] }]
      },
      options: { plugins: { legend: { position: 'bottom' } }, cutout: '60%' }
    });
  }

  const viewsSeries = JSON.parse('{{ views_series_json|default:"[]"|escapejs }}'); // [{date:'2025-11-01', views:12}, ...]
  const viewCtx = document.getElementById('chartViews');
  if (viewCtx) {
    new Chart(viewCtx, {
      type: 'line',
      data: {
        labels: viewsSeries.map(v => v.date),
        datasets: [{
          label: 'Views',
          data: viewsSeries.map(v => v.views),
          borderColor: '#1f7ae0',
          backgroundColor: 'rgba(31,122,224,0.1)',
          tension: .3,
          fill: true
        }]
      },
      options: {
        plugins: { legend: { display: false } },
        scales: { y: { beginAtZero: true } }
      }
    });
  }

  // Initialize
  $(document).ready(function() {
    applyFilters();
    $('[data-bs-toggle="tooltip"]').tooltip();
  });
</script>
<!-- TinyMCE CDN -->

<script>
  var quill = new Quill('#description-editor', {
    theme: 'snow',
    modules: {
      toolbar: [
        [{ 'font': [] }, { 'size': [] }],
        ['bold', 'italic', 'underline', 'strike'],
        [{ 'color': [] }, { 'background': [] }],
        [{ 'list': 'ordered'}, { 'list': 'bullet' }],
        [{ 'align': [] }],
        ['link', 'image'],
        ['clean']
      ]
    }
  });

  // Save HTML content into hidden input on form submit
  var form = document.querySelector('form');
  form.onsubmit = function() {
    document.querySelector('#description').value = quill.root.innerHTML;
  };
</script>

<script>
  tinymce.init({
    selector: '#description',   // target your textarea by ID
    plugins: 'lists link image table code',
    toolbar: 'undo redo | bold italic underline | fontfamily fontsize | forecolor backcolor | bullist numlist | alignleft aligncenter alignright | code',
    menubar: false,
    height: 300,
    font_family_formats: 'Arial=arial,helvetica,sans-serif; Courier New=courier new,courier,monospace; Georgia=georgia,serif; Tahoma=tahoma,sans-serif; Times New Roman=times new roman,times,serif; Verdana=verdana,sans-serif',
    fontsize_formats: '8pt 10pt 12pt 14pt 18pt 24pt 36pt'
  });
</script>

</body>
</html>
