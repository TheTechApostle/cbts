{% load django_browser_reload %}
{% django_browser_reload_script %}
{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>{{ student.full_name }} - Scores</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  
</head>
<body class="bg-light">

<div class="container mt-5">
  <div class="card shadow-lg">
    <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
      <h5 class="mb-0">
        <i class="fa fa-graduation-cap me-2"></i>
        {{ student.full_name }}’s Scores
      </h5>
      
      <div class="btn-group">
        <!-- Add Assessment Score -->
        <button type="button" class="btn btn-light btn-sm" data-bs-toggle="modal" data-bs-target="#addScoreModal">
          <i class="fa fa-plus text-info me-1"></i> Add Assessment Score
        </button>

        <!-- Download Assessment -->
        <a href="{% url 'export_student_scores_csv' student.id course.id %}" class="btn btn-light btn-sm text-info text-decoration-none">
          <i class="fa fa-download me-1"></i> Download Assessment
        </a>

        <!-- Print Score -->
        <button type="button" class="btn btn-outline-light btn-sm text-black" onclick="print()">
          <i class="fa fa-print me-1"></i> Print Score
        </button>
      </div>
    </div>

    <div class="card-body">
      {% if scores %}
      <div class="table-responsive">        
        <table class="table table-striped align-middle" style="font-size: 13px;">
          <thead class="table-info">
            <tr>
              <th>#</th>
              <th>Exam Title</th>
              <th>Course</th>
              <th>Department</th>
              <th>Total Questions</th>
              <th>Total Score</th>
              <th>Assessment</th> 
              <th>Percentage</th>
              <th>Date Taken</th>
            </tr>
          </thead>
          <tbody>
            {% for score in scores %}
                <tr>
                <td>{{ forloop.counter }}</td>
                <td>{{ score.course.title }}</td>
                <td>{{ score.department.name|default:"-" }}</td>
                <td>{{ score.class_group.name }}</td>
                <td>{{ score.total_questions }}</td>
                <td>{{ score.total_score }}</td>
                <td>{{ total_score_sum }}</td>
                <td><strong>{{ total_percentage }}%</strong></td>
                <td>{{ score.date_added|date:"M d, Y" }}</td>
                </tr>
                {% endfor %}

          </tbody>
        </table>
      </div>
      {% else %}
      <div class="alert alert-warning mb-0">
        No exam scores found for this student.
      </div>
      {% endif %}
    </div>
    <div class="card-body">
      <h3>TEST SCORES </h3>
      {% if Testscores %}
     <div class="table-responsive">
      <table class="table table-striped align-middle" style="font-size: 13px;">
        <thead class="table-info">
          <span class="h4 my-2">Total Test Aggregate: <span class='btn btn-primary mx-2'><b> {{total_score_sum}}</b></span> - <span class="text-danger">{{test_percentage}}%</span></span>
          <tr>
            <th>#</th>
            <th>Exam Title</th>
           
            <th>Department</th>
            <th>Class Group</th>
            <th>Total Questions</th>
            <th>Total Score</th>
            <th>Term</th>
            <th>Percentage</th>
            <th>Date Taken</th>
          </tr>
        </thead>
        <tbody>
          {% for score in Testscores %}
            <tr>
              <td>{{ forloop.counter }}</td>
              <td>{{ score.course.title }}</td>
              <td>{{ score.department.name|default:"-" }}</td>
              <td>{{ score.class_group }}</td>   <!-- updated -->
              <td>{{ score.total_questions }}</td>
              <td>{{ score.total_score }}</td>
              <td>{{ score.test_type }}</td>
              <td><strong>{{ score.percentage }}%</strong></td>
              <td>{{ score.date_added|date:"M d, Y" }}</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

      {% else %}
      <div class="alert alert-warning mb-0">
        No Test scores found for this student.
      </div>
      {% endif %}
    </div>
    <div class="card-footer text-end">
      <a href="{% url 'Teacherdashboard' %}" class="btn btn-secondary btn-sm">
        <i class="fa fa-arrow-left me-1"></i> Back
      </a>
    </div>
  </div>
</div>
<!-- Add Test Score Modal -->
<div class="modal fade" id="addScoreModal" tabindex="-1" aria-labelledby="addScoreModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-info text-white">
        <h5 class="modal-title" id="addScoreModalLabel">
          <i class="fa fa-plus me-2"></i> Add Test Score
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <form method="POST" action="{% url 'student_score' student.id course.id %}" id="scoreForm">
        {% if messages %}
            <div class="container mt-3">
                {% for message in messages %}
                <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
                {% endfor %}
            </div>
        {% endif %}

        {% csrf_token %}
        <div class="modal-body">
          <div class="row g-3">

            <!-- Student -->
            <div class="col-md-6">
              <label class="form-label">Student</label>
              <input type="text" class="form-control" value="{{ student.full_name }}" readonly>
            </div>

            <!-- Course -->
            <div class="col-md-6">
              <label class="form-label">Course</label>
              <input type="text" class="form-control" value="{{ course.title }}" readonly>
            </div>

            <!-- Department -->
            <div class="col-md-6">
              <label class="form-label">Department</label>
              <input type="text" class="form-control" value="{{ student.department.name }}" readonly>
            </div>

            <!-- Class/Level -->
            <div class="col-md-6">
                <label class="form-label">Level / Class</label>

                <!-- Hidden field that submits the actual ClassGroup ID -->
                <!-- Hidden input submits the ClassGroup ID -->
                <input type="hidden" name="level_or_class" value="{{ student.level_or_class.id }}">

                <!-- Display the readable name to the user -->
                <input type="text" class="form-control" 
                      value="{{ student.level_or_class }}" readonly>

            </div>

            <!-- Total Questions -->
            <div class="col-md-6">
              <label class="form-label">Total Questions</label>
              <input type="number" name="total_questions" class="form-control" placeholder="e.g., 50" required>
            </div>

            <!-- Scored Score -->
            <div class="col-md-3">
              <label class="form-label">Scored / Obtained Score</label>
              <input type="number" name="total_score" class="form-control" placeholder="e.g., 45" required>
            </div>
            <div class="col-md-3">
              <label class="form-label">Assessment Type</label>
              <select class="form-control" name="test_type">
                <option value="1st Test">1st Test</option>
                <option value="2nd Test">2nd Test</option>
                <option value="3rd Test">3rd Test</option>  <!-- Corrected duplicate -->
              </select>
            </div>
          </div>
        </div>

        <div class="modal-footer">
          <button type="submit" class="btn btn-info text-white">
            <i class="fa fa-save me-1"></i> Save Score
          </button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        </div>
      </form>

    </div>
  </div>
</div>
<!-- Bootstrap Bundle with Popper (for Modal, Dropdowns, etc.) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<!-- Optional: jQuery (only if you plan to use AJAX later) -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script>
$(document).ready(function() {
  $('#scoreForm').on('submit', function(e) {
    e.preventDefault();

    $.ajax({
      type: 'POST',
      url: $(this).attr('action'),
      data: $(this).serialize(),
      headers: {
        'X-CSRFToken': $('input[name=csrfmiddlewaretoken]').val()  // ✅ Include CSRF
      },
      success: function(response) {
        alert('✅ Test score added successfully!');
        $('#addScoreModal').modal('hide');
        location.reload();  // reload or dynamically update your score list
      },
      error: function(xhr) {
        alert('❌ Error: ' + xhr.responseText);
      }
    });
  });
});
</script> 

</body>
</html>
